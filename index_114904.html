<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSTR Calculation</title>
  <style>
    body {
      font-family: 'Times New Roman', serif;
      background: linear-gradient(to right, #e0f7fa, #f1f8e9);
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2e7d32;
    }
    label {
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #ffffff;
    }
    th, td {
      border: 1px solid #999;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #a5d6a7;
    }
    input[type="number"] {
      width: 145px;
      padding: 6px;
    }
    button {
      margin-top: 10px;
      padding: 8px 12px;
      border: none;
      background-color: #4caf50;
      color: white;
      font-size: 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .delete-btn {
      background-color: #f44336;
    }
    .delete-btn:hover {
      background-color: #d32f2f;
    }
    .results {
      margin-top: 20px;
      font-size: 18px;
      background: #f9fbe7;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #c5e1a5;
    }
    .author {
      margin-top: 40px;
      text-align: center;
      font-style: italic;
      color: #555;
    }
  </style>
</head>
<body>

<h1>CSTR Calculation</h1>

<div>
  <label>Conversion (x̄): </label>
  <input type="number" id="conversion" step="0.001" placeholder="Enter conversion in %">
</div>
<br>

<table id="inputTable">
  <thead>
    <tr>
      <th>Time (T)</th>
      <th>Concentration (C)</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="addRow()">Add Data Row</button>
<button onclick="calculate()">Calculate</button>

<div id="output"></div>

<div class="author"><br>Creator: Subham Patel</br>
  <b><br>**Note**</br></b>
  <br>>> While providing the data check for the units mentioned on the screen.
  <br>>> For any suggestions or complaints, please reach out on WhatsApp.</br>
<br><br>
    <a href="https://wa.me/918763221768?text=I%20have%20a%20suggestion%20or%20complaint%20regarding%20the%20CSTR%20Calculation%20tool." target="_blank">
        <button style="background-color: #25D366; color: white; border: none; padding: 10px 20px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 5px;">
            <i class="fab fa-whatsapp"></i> WhatsApp
        </button>
    </a></div>

<script>
  function addRow() {
    const table = document.getElementById('inputTable').getElementsByTagName('tbody')[0];
    const row = table.insertRow();
    row.innerHTML = `
      <td><input type="number" step="0.001" class="time" placeholder="min"></td>
      <td><input type="number" step="0.001" class="conc" placeholder="gm/l"></td>
      <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
    `;
  }

  function deleteRow(btn) {
    btn.closest('tr').remove();
  }

  function truncateNoRound(num, decimals) {
    const factor = Math.pow(10, decimals);
    return Math.trunc(num * factor) / factor;
  }

  function calculate() {
    const times = Array.from(document.querySelectorAll('.time')).map(input => parseFloat(input.value));
    const concs = Array.from(document.querySelectorAll('.conc')).map(input => parseFloat(input.value));
    const xbar = parseFloat(document.getElementById('conversion').value) / 100;

    if (times.length < 2 || concs.length !== times.length || isNaN(xbar)) {
      alert("Please enter at least two data rows and a valid conversion value.");
      return;
    }
    if (times.some(isNaN) || concs.some(isNaN)) {
      alert("Please fill all time and concentration fields with valid numbers.");
      return;
    }

    const Δt = times.map((t, i) => i === 0 ? 0 : t - times[i - 1]);
    const CΔt = concs.map((c, i) => c * Δt[i]);
    const TCΔt = CΔt.map((val, i) => times[i] * val);

    const ΣCΔt = CΔt.reduce((a, b) => a + b, 0);
    const ΣTCΔt = TCΔt.reduce((a, b) => a + b, 0);
    const χ = ΣTCΔt / ΣCΔt;

    const E = concs.map(c => c === 0 ? 0 : truncateNoRound(c / ΣCΔt, 3));

    const fullK = xbar / (χ * (1 - xbar));
    const k = Math.trunc(fullK * 10000) / 10000; // truncate to 4 d.p.

    // Find precision based on last time point e^-kt
    const lastTime = times[times.length - 1];
    const lastExp = Math.exp(-k * lastTime);
    let fractional = lastExp.toString().split('.')[1] || "";
    let precision = 3; // default
    for (let i = 0; i < fractional.length; i++) {
      if (fractional[i] !== '0') {
        precision = i + 1;
        break;
      }
    }

    // Calculate e^-kt and truncate to precision (no rounding)
    const ekt = times.map(t => truncateNoRound(Math.exp(-k * t), precision));
    const EeDeltaT = E.map((e, i) => truncateNoRound(e * ekt[i] * Δt[i], precision));

    const ΣEeDeltaT = EeDeltaT.reduce((sum, val) => sum + val, 0);
    const expectedConversion = truncateNoRound(1 - ΣEeDeltaT, precision);

    let html = `<table>
      <thead>
        <tr>
          <th>T</th><th>C</th><th>Δt</th><th>C·Δt</th><th>T(C·Δt)</th>
         <th>E (Actual)</th><th>E (3 d.p.)</th><th>e<sup>-kt</sup> (trunc. ${precision} d.p.)</th><th>E·e<sup>-kt</sup>·Δt</th>
        </tr>
      </thead>
      <tbody>`;

    for (let i = 0; i < times.length; i++) {
      html += `<tr>
        <td>${times[i]}</td>
        <td>${concs[i]}</td>
        <td>${Δt[i].toFixed(3)}</td>
        <td>${CΔt[i].toFixed(3)}</td>
        <td>${TCΔt[i].toFixed(3)}</td>
        <td>${(concs[i] / ΣCΔt).toFixed(6)}</td>
        <td>${E[i]}</td>
        <td>${ekt[i].toFixed(precision)}</td>
        <td>${EeDeltaT[i].toFixed(precision)}</td>
      </tr>`;
    }

    html += `</tbody>
      <tfoot>
        <tr>
          <td></td><td></td><td></td>
          <td><b>${ΣCΔt.toFixed(3)}</b></td>
          <td><b>${ΣTCΔt.toFixed(3)}</b></td>
          <td></td><td></td><td></td>
          <td><b>${ΣEeDeltaT}</b></td>
        </tr>
      </tfoot>
    </table>
      <div class="results" style="text-align: center;">
        Mean residence time (χ): ${χ.toFixed(4)}<br>
        Rate constant (k): ${k}<br>
        Expected conversion: ${expectedConversion.toFixed(precision)} or ${(expectedConversion * 100).toFixed(precision)}%
      </div>`;
    document.getElementById('output').innerHTML = html;
  }
</script>

</body>
</html>
